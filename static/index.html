<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Kniha jízd 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 2em;}
    .container { background: #fff; padding: 2em; border-radius: 12px; max-width: 700px; margin: 0 auto; box-shadow: 0 0 10px #ddd;}
    h1 { text-align: center; }
    label { font-weight: bold; }
    .row { margin-bottom: 1.3em;}
    select, input, button { padding: .5em; border-radius: 6px; border: 1px solid #bbb; font-size: 1em;}
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ddd; padding: .4em; text-align: left;}
    th { background: #f1f1f1; }
    .center { text-align: center;}
    .success { color: green; margin-top: 1em;}
    .error { color: #c00; margin-top: 1em;}
    .actions { margin-top: 2em; text-align: center; }
    .small { font-size: .85em; color: #888;}
    .disabled { background: #f7f7f7; color: #aaa; }
  </style>
</head>
<body>
<div class="container">
  <h1>Kniha jízd 2.0</h1>

  <div class="row">
    <label for="car-select">Vyberte vozidlo:</label><br>
    <select id="car-select">
      <option value="">-- Zvolte vozidlo --</option>
    </select>
  </div>

  <div class="row">
    <label>Události (každý řádek = jedna událost):</label>
    <table id="events-table">
      <thead>
        <tr>
          <th>Druh události</th>
          <th>Datum</th>
          <th>Datum konce</th>
          <th>Místo</th>
          <th>Poznámka</th>
          <th>Množství (l)</th>
          <th>Smazat</th>
        </tr>
      </thead>
      <tbody id="events-body"></tbody>
    </table>
    <button type="button" onclick="addEventRow()">Přidat událost</button>
    <div class="small">Pro ubytování zadejte také datum konce. Množství (l) vyplňte jen pro tankování.</div>
  </div>

  <div class="actions">
    <button type="button" onclick="simulate()" style="font-size:1.2em;">Simulovat a stáhnout Excel</button>
  </div>
  <div id="result"></div>
</div>

<script>
let cars = [];

function fetchCars() {
  fetch('/cars')
    .then(res => res.json())
    .then(data => {
      cars = data;
      let select = document.getElementById("car-select");
      select.innerHTML = '<option value="">-- Zvolte vozidlo --</option>';
      data.forEach((car, i) => {
        let opt = document.createElement("option");
        opt.value = i;
        opt.innerText = `${car.RZ} (${car.Vozidlo})`;
        select.appendChild(opt);
      });
    });
}

function addEventRow() {
  let tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <select onchange="toggleLitryInput(this)">
        <option value="">--</option>
        <option value="Tankování">Tankování</option>
        <option value="Ubytování">Ubytování</option>
        <option value="Hotel">Hotel</option>
        <option value="Technická kontrola">Technická kontrola</option>
        <option value="Jiné">Jiné</option>
      </select>
    </td>
    <td><input type="date"></td>
    <td><input type="date"></td>
    <td><input type="text" placeholder="Zadejte místo"></td>
    <td><input type="text" placeholder="Poznámka"></td>
    <td><input type="number" step="0.01" min="0" disabled class="litry"></td>
    <td class="center"><button type="button" onclick="this.closest('tr').remove()">❌</button></td>
  `;
  document.getElementById("events-body").appendChild(tr);
}
addEventRow(); // První řádek po načtení

// Povolení/zakázání pole "Množství (l)"
function toggleLitryInput(selectEl) {
  let tr = selectEl.closest('tr');
  let litryInput = tr.querySelector('.litry');
  if (selectEl.value === "Tankování") {
    litryInput.disabled = false;
    litryInput.classList.remove('disabled');
  } else {
    litryInput.disabled = true;
    litryInput.value = "";
    litryInput.classList.add('disabled');
  }
}

function simulate() {
  document.getElementById("result").innerHTML = "";
  let carIdx = document.getElementById("car-select").value;
  if (carIdx === "") { showError("Vyberte vozidlo."); return; }
  let car = cars[carIdx];
  let events = [];
  let valid = true;
  document.querySelectorAll("#events-body tr").forEach(tr => {
    let tds = tr.querySelectorAll("td");
    let typ = tds[0].querySelector('select').value;
    let datum = tds[1].querySelector('input').value;
    let datum_konec = tds[2].querySelector('input').value;
    let misto = tds[3].querySelector('input').value.trim();
    let poznamka = tds[4].querySelector('input').value.trim();
    let litry = tds[5].querySelector('input').value;
    // Validation
    if (!typ || !datum || !misto) {
      valid = false;
    }
    events.push({
      typ,
      datum,
      datum_konec: (typ === "Ubytování" || typ === "Jiné") ? datum_konec : "",
      misto,
      poznamka,
      mnozstvi: typ === "Tankování" ? parseFloat(litry || 0) : ""
    });
  });
  if (!valid) {
    showError("Vyplňte druh, datum a místo u všech událostí!");
    return;
  }
  document.getElementById("result").innerHTML = "Simulace probíhá...";
  fetch("/simulate", {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({car, events})
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      document.getElementById("result").innerHTML =
        `<a class="success" href="${data.download_url}">Stáhnout vygenerovaný Excel</a>`;
    } else {
      showError("Simulace se nezdařila. Zkuste znovu.");
    }
  })
  .catch(err => showError("Chyba připojení k serveru."));
}
function showError(msg) {
  document.getElementById("result").innerHTML = `<span class="error">${msg}</span>`;
}

fetchCars();
</script>
</body>
</html>
